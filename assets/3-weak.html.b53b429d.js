import{r as l,o as c,c as o,a as n,e as s,F as r,d as t,b as e}from"./app.01142347.js";import{_ as i}from"./plugin-vue_export-helper.21dcd24c.js";const p={},d=t(`<p>weak \u7684\u7528\u5904\u7528\u4E00\u53E5\u8BDD\u53EF\u5F52\u7EB3\u4E3A\uFF1A<strong>\u5F31\u5F15\u7528\uFF0C\u5728\u5BF9\u8C61\u91CA\u653E\u540E\u7F6E\u4E3A nil\uFF0C\u907F\u514D\u9519\u8BEF\u7684\u5185\u5B58\u8BBF\u95EE</strong>\u3002<br>\u7528\u66F4\u901A\u4FD7\u7684\u8BDD\u6765\u8868\u8FF0\u662F\uFF1Aweak \u53EF\u4EE5\u5728\u4E0D\u589E\u52A0\u5BF9\u8C61\u7684\u5F15\u7528\u8BA1\u6570\u7684\u540C\u65F6\uFF0C\u53C8\u4F7F\u5F97\u6307\u9488\u7684\u8BBF\u95EE\u662F\u5B89\u5168\u7684\u3002</p><h4 id="\u5B9E\u73B0weak\u540E-\u4E3A\u4EC0\u4E48\u5BF9\u8C61\u91CA\u653E\u540E\u4F1A\u81EA\u52A8\u4E3Anil" tabindex="-1"><a class="header-anchor" href="#\u5B9E\u73B0weak\u540E-\u4E3A\u4EC0\u4E48\u5BF9\u8C61\u91CA\u653E\u540E\u4F1A\u81EA\u52A8\u4E3Anil" aria-hidden="true">#</a> \u5B9E\u73B0weak\u540E\uFF0C\u4E3A\u4EC0\u4E48\u5BF9\u8C61\u91CA\u653E\u540E\u4F1A\u81EA\u52A8\u4E3Anil</h4><p><code>runtime</code> \u5BF9\u6CE8\u518C\u7684\u7C7B\uFF0C \u4F1A\u8FDB\u884C\u5E03\u5C40\uFF0C\u5BF9\u4E8E weak \u5BF9\u8C61\u4F1A\u653E\u5165\u4E00\u4E2A <code>hash</code> \u8868\u4E2D\u3002 \u7528 weak \u6307\u5411\u7684\u5BF9\u8C61\u5185\u5B58\u5730\u5740\u4F5C\u4E3A key\uFF0C\u5F53\u6B64\u5BF9\u8C61\u7684\u5F15\u7528\u8BA1\u6570\u4E3A 0 \u7684\u65F6\u5019\u4F1A dealloc\uFF0C\u5047\u5982 weak \u6307\u5411\u7684\u5BF9\u8C61\u5185\u5B58\u5730\u5740\u662F a \uFF0C\u90A3\u4E48\u5C31\u4F1A\u4EE5 a \u4E3A\u952E\uFF0C \u5728\u8FD9\u4E2A weak \u8868\u4E2D\u641C\u7D22\uFF0C\u627E\u5230\u6240\u6709\u4EE5 a \u4E3A\u952E\u7684 weak \u5BF9\u8C61\uFF0C\u4ECE\u800C\u8BBE\u7F6E\u4E3A <code>nil</code> \u3002</p><h4 id="\u5F53weak\u5F15\u7528\u6307\u5411\u7684\u5BF9\u8C61\u88AB\u91CA\u653E\u65F6-\u53C8\u662F\u5982\u4F55\u53BB\u5904\u7406weak\u6307\u9488\u7684\u5462" tabindex="-1"><a class="header-anchor" href="#\u5F53weak\u5F15\u7528\u6307\u5411\u7684\u5BF9\u8C61\u88AB\u91CA\u653E\u65F6-\u53C8\u662F\u5982\u4F55\u53BB\u5904\u7406weak\u6307\u9488\u7684\u5462" aria-hidden="true">#</a> \u5F53weak\u5F15\u7528\u6307\u5411\u7684\u5BF9\u8C61\u88AB\u91CA\u653E\u65F6\uFF0C\u53C8\u662F\u5982\u4F55\u53BB\u5904\u7406weak\u6307\u9488\u7684\u5462\uFF1F</h4><ol><li>\u8C03\u7528 objc_release</li><li>\u56E0\u4E3A\u5BF9\u8C61\u7684\u5F15\u7528\u8BA1\u6570\u4E3A0\uFF0C\u6240\u4EE5\u6267\u884C dealloc</li><li>\u5728 dealloc\u4E2D\uFF0C\u8C03\u7528\u4E86_objc_rootDealloc \u51FD\u6570</li><li>\u5728 _objc_rootDealloc \u4E2D\uFF0C\u8C03\u7528\u4E86object_dispose \u51FD\u6570</li><li>\u8C03\u7528 objc_destructInstance</li><li>\u6700\u540E\u8C03\u7528 objc_clear_deallocating,\u8BE6\u7EC6\u8FC7\u7A0B\u5982\u4E0B\uFF1A</li></ol><div class="language-text ext-text line-numbers-mode"><pre class="language-text"><code>a. \u4ECEweak\u8868\u4E2D\u83B7\u53D6\u5E9F\u5F03\u5BF9\u8C61\u7684\u5730\u5740\u4E3A\u952E\u503C\u7684\u8BB0\u5F55
b. \u5C06\u5305\u542B\u5728\u8BB0\u5F55\u4E2D\u7684\u6240\u6709\u9644\u6709 weak \u4FEE\u9970\u7B26\u53D8\u91CF\u7684\u5730\u5740\uFF0C\u8D4B\u503C\u4E3A nil
c. \u5C06 weak \u8868\u4E2D\u8BE5\u8BB0\u5F55\u5220\u9664
d. \u4ECE\u5F15\u7528\u8BA1\u6570\u8868\u4E2D\u5220\u9664\u5E9F\u5F03\u5BF9\u8C61\u7684\u5730\u5740\u4E3A\u952E\u503C\u7684\u8BB0\u5F55
</code></pre><div class="line-numbers" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br></div></div><h4 id="weak\u5B9E\u73B0\u539F\u7406" tabindex="-1"><a class="header-anchor" href="#weak\u5B9E\u73B0\u539F\u7406" aria-hidden="true">#</a> weak\u5B9E\u73B0\u539F\u7406\uFF1A</h4><p><code>Runtime</code> \u7EF4\u62A4\u4E86\u4E00\u4E2A weak \u8868\uFF0C\u7528\u4E8E\u5B58\u50A8\u6307\u5411\u67D0\u4E2A\u5BF9\u8C61\u7684\u6240\u6709 weak \u6307\u9488\u3002weak \u8868\u5176\u5B9E\u662F\u4E00\u4E2Ahash\uFF08\u54C8\u5E0C\uFF09\u8868\uFF0Ckey \u662F\u6240\u6307\u5BF9\u8C61\u7684\u5730\u5740\uFF0Cvalue \u662F weak \u6307\u9488\u7684\u5730\u5740\uFF08\u8FD9\u4E2A\u5730\u5740\u7684\u503C\u662F\u6240\u6307\u5BF9\u8C61\u6307\u9488\u7684\u5730\u5740\uFF09\u6570\u7EC4\u3002</p><ol><li>\u521D\u59CB\u5316\u65F6\uFF1Aruntime \u4F1A\u8C03\u7528 <code>objc_initWeak</code> \u51FD\u6570\uFF0C\u521D\u59CB\u5316\u4E00\u4E2A\u65B0\u7684 weak \u6307\u9488\u6307\u5411\u5BF9\u8C61\u7684\u5730\u5740\u3002</li><li>\u6DFB\u52A0\u5F15\u7528\u65F6\uFF1A<code>objc_initWeak </code>\u51FD\u6570\u4F1A\u8C03\u7528 <code>objc_storeWeak()</code> \u51FD\u6570\uFF0C <code>objc_storeWeak()</code> \u7684\u4F5C\u7528\u662F\u66F4\u65B0\u6307\u9488\u6307\u5411\uFF0C\u521B\u5EFA\u5BF9\u5E94\u7684\u5F31\u5F15\u7528\u8868\u3002</li><li>\u91CA\u653E\u65F6\uFF0C\u8C03\u7528 <code>clearDeallocating</code> \u51FD\u6570\u3002<code>clearDeallocating</code> \u51FD\u6570\u9996\u5148\u6839\u636E\u5BF9\u8C61\u5730\u5740\u83B7\u53D6\u6240\u6709 weak \u6307\u9488\u5730\u5740\u7684\u6570\u7EC4\uFF0C\u7136\u540E\u904D\u5386\u8FD9\u4E2A\u6570\u7EC4\u628A\u5176\u4E2D\u7684\u6570\u636E\u8BBE\u4E3A nil\uFF0C\u6700\u540E\u628A\u8FD9\u4E2A entry \u4ECE weak \u8868\u4E2D\u5220\u9664\uFF0C\u6700\u540E\u6E05\u7406\u5BF9\u8C61\u7684\u8BB0\u5F55\u3002</li></ol><h4 id="sidetable" tabindex="-1"><a class="header-anchor" href="#sidetable" aria-hidden="true">#</a> SideTable</h4>`,10),b=n("code",null,"SideTable ",-1),u=e("\u662F\u4E00\u4E2A\u7528 "),k=n("code",null,"C++",-1),h=e(" \u5B9E\u73B0\u7684\u7C7B\uFF0C\u5B83\u7684\u5177\u4F53\u5B9A\u4E49\u5728"),m={href:"https://opensource.apple.com/source/objc4/objc4-532.2/runtime/NSObject.mm",target:"_blank",rel:"noopener noreferrer"},_=e("NSObject.mm"),w=e("\u4E2D, \u5B83\u4E3B\u8981\u7528\u4E8E\u7BA1\u7406\u5BF9\u8C61\u7684\u5F15\u7528\u8BA1\u6570\u548C weak \u8868\u3002\u5728 NSObject.mm \u4E2D\u58F0\u660E\u5176\u6570\u636E\u7ED3\u6784\uFF1A"),g=t(`<div class="language-c ext-c line-numbers-mode"><pre class="language-c"><code><span class="token keyword">struct</span> <span class="token class-name">SideTable</span> <span class="token punctuation">{</span>
	<span class="token comment">// \u4FDD\u8BC1\u539F\u5B50\u64CD\u4F5C\u7684\u81EA\u65CB\u9501</span>
    <span class="token class-name">spinlock_t</span> slock<span class="token punctuation">;</span>
    <span class="token comment">// \u5F15\u7528\u8BA1\u6570\u7684 hash \u8868</span>
    RefcountMap refcnts<span class="token punctuation">;</span>
    <span class="token comment">// weak \u5F15\u7528\u5168\u5C40 hash \u8868</span>
    <span class="token class-name">weak_table_t</span> weak_table<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br></div></div>`,1),f=e("weak\u8868\u662F\u4E00\u4E2A\u5F31\u5F15\u7528\u8868\uFF0C\u5B9E\u73B0\u4E3A\u4E00\u4E2Aweak_table_t\u7ED3\u6784\u4F53\uFF0C\u5B58\u50A8\u4E86\u67D0\u4E2A\u5BF9\u8C61\u76F8\u5173\u7684\u7684\u6240\u6709\u7684\u5F31\u5F15\u7528\u4FE1\u606F\u3002\u5176\u5B9A\u4E49\u5982\u4E0B(\u5177\u4F53\u5B9A\u4E49\u5728"),j={href:"https://opensource.apple.com/source/objc4/objc4-646/runtime/objc-weak.h",target:"_blank",rel:"noopener noreferrer"},x=e("objc-weak.h"),v=e("\u4E2D)\uFF1A"),S=t(`<div class="language-c ext-c line-numbers-mode"><pre class="language-c"><code><span class="token keyword">struct</span> <span class="token class-name">weak_table_t</span> <span class="token punctuation">{</span>
    <span class="token comment">// \u4FDD\u5B58\u4E86\u6240\u6709\u6307\u5411\u6307\u5B9A\u5BF9\u8C61\u7684 weak \u6307\u9488</span>
    <span class="token class-name">weak_entry_t</span> <span class="token operator">*</span>weak_entries<span class="token punctuation">;</span>
    <span class="token comment">// \u5B58\u50A8\u7A7A\u95F4</span>
    <span class="token class-name">size_t</span>    num_entries<span class="token punctuation">;</span>
    <span class="token comment">// \u53C2\u4E0E\u5224\u65AD\u5F15\u7528\u8BA1\u6570\u8F85\u52A9\u91CF</span>
    <span class="token class-name">uintptr_t</span> mask<span class="token punctuation">;</span>
    <span class="token comment">// hash key \u6700\u5927\u504F\u79FB\u503C</span>
    <span class="token class-name">uintptr_t</span> max_hash_displacement<span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br></div></div><h4 id="weak-singleton" tabindex="-1"><a class="header-anchor" href="#weak-singleton" aria-hidden="true">#</a> weak singleton</h4><p>\u5728\u6240\u6709\u4F7F\u7528\u8BE5\u5355\u4F8B\u7684\u5BF9\u8C61\u90FD\u91CA\u653E\u540E\uFF0C\u5355\u4F8B\u5BF9\u8C61\u672C\u8EAB\u4E5F\u4F1A\u81EA\u5DF1\u91CA\u653E\u3002\u6211\u6240\u89C1\u8FC7\u7684\u5927\u90E8\u5206\u5355\u4F8B\u4F7F\u7528\u573A\u666F\uFF0C\u88AB\u521B\u5EFA\u90FD\u5355\u4F8B\u6700\u540E\u90FD\u4F1A\u4E00\u76F4\u5B58\u6D3B\u7740\uFF0C\u6BD4\u5982\u6CE8\u518C\u767B\u5F55\u6A21\u5757\u6240\u9700\u8981\u5171\u4EAB\u72B6\u6001\u6240\u521B\u5EFA\u7684 <code>XXLoginManager</code>\uFF0C\u5373\u4F7F\u5728\u7528\u6237\u6CE8\u518C\u6210\u529F\u8FDB\u5165\u4E3B\u754C\u9762\u4E4B\u540E\u4E5F\u4E0D\u4F1A\u88AB\u663E\u5F0F\u7684\u91CA\u653E\uFF0C\u8FD9\u5728\u4E00\u5B9A\u7A0B\u5EA6\u4E0A\u4F1A\u5E26\u6765\u5185\u5B58\u4F7F\u7528\u7684\u6D6A\u8D39\u3002\u6240\u8C13\u7684\u300C<code>weak singleton</code>\u300D\u4EE3\u7801\u5F88\u7B80\u5355\uFF1A</p><div class="language-text ext-text line-numbers-mode"><pre class="language-text"><code>+ (id)sharedInstance
{
    static __weak ASingletonClass *instance;
    ASingletonClass *strongInstance = instance;
    @synchronized(self) {
        if (strongInstance == nil) {
            strongInstance = [[[self class] alloc] init];
            instance = strongInstance;
        }
    }
    return strongInstance;
}
</code></pre><div class="line-numbers" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br></div></div><p>Controller A\uFF0C B\uFF0C C \u90FD\u53EF\u4EE5\u6301\u6709 <code>ASingletonClass</code> \u7684\u5F3A\u5F15\u7528\uFF0C\u4E00\u65E6 A\uFF0CB\uFF0CC \u90FD\u9500\u6BC1\u540E\uFF0C<code>ASingletonClass</code> \u7684\u5355\u4F8B\u5BF9\u8C61\u4E5F\u4F1A\u968F\u4E4B\u9500\u6BC1\uFF0C\u7565\u5DE7\u5999\u4E0D\u662F\u5417\uFF1F</p><p>\u300Cweak singleton\u300D\u8FD9\u4E2A\u6F02\u4EAE\u540D\u5B57\u80CC\u540E\u5176\u5B9E\u53EA\u662F\u7B80\u5355\u800C\u5DE7\u5999\u7684\u5229\u7528\u4E86 weak \u7279\u6027\uFF0CsharedInstance \u4E2D\u7684 weak \u5C31\u50CF\u662F\u4E00\u4E2A\u667A\u80FD\u7BA1\u5BB6\uFF0C\u5728\u65E0\u4EBA\u4F7F\u7528 instance \u4E4B\u540E\u5C31\u7F6E\u4E3A nil \u9500\u6BC1\uFF0C\u5F53 sharedInstance \u518D\u6B21\u88AB\u8C03\u7528\u65F6\uFF0Cinstance \u53C8\u4F1A\u91CD\u65B0\u88AB\u521B\u5EFA\u3002</p><h4 id="\u53C2\u8003" tabindex="-1"><a class="header-anchor" href="#\u53C2\u8003" aria-hidden="true">#</a> \u53C2\u8003</h4>`,7),y={href:"http://mrpeak.cn/blog/ios-weak/",target:"_blank",rel:"noopener noreferrer"},C=e("iOS weak \u5173\u952E\u5B57\u6F2B\u8C08"),I={href:"https://www.jianshu.com/p/7c6400a04e58",target:"_blank",rel:"noopener noreferrer"},O=e("iOS-\u5B9E\u73B0weak\u540E\uFF0C\u4E3A\u4EC0\u4E48\u5BF9\u8C61\u91CA\u653E\u540E\u4F1A\u81EA\u52A8\u4E3Anil"),A={href:"https://www.jianshu.com/p/13c4fb1cedea",target:"_blank",rel:"noopener noreferrer"},N=e("iOS \u5E95\u5C42\u89E3\u6790weak\u7684\u5B9E\u73B0\u539F\u7406"),B={href:"http://zhoulingyu.com/2017/02/15/Advanced-iOS-Study-objc-Memory-2/",target:"_blank",rel:"noopener noreferrer"},T=e("iOS\uFF08Objective-C\uFF09\u5185\u5B58\u7BA1\u7406"),W={href:"http://yulingtianxia.com/blog/2015/12/06/The-Principle-of-Refenrence-Counting/",target:"_blank",rel:"noopener noreferrer"},D=e("Objective-C \u5F15\u7528\u8BA1\u6570\u539F\u7406");function V(z,E){const a=l("ExternalLinkIcon");return c(),o(r,null,[d,n("p",null,[b,u,k,h,n("a",m,[_,s(a)]),w]),g,n("p",null,[f,n("a",j,[x,s(a)]),v]),S,n("ol",null,[n("li",null,[n("a",y,[C,s(a)])]),n("li",null,[n("a",I,[O,s(a)])]),n("li",null,[n("a",A,[N,s(a)])]),n("li",null,[n("a",B,[T,s(a)])]),n("li",null,[n("a",W,[D,s(a)])])])],64)}var R=i(p,[["render",V]]);export{R as default};
